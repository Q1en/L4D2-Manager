# L4D2 服务器与插件管理器

## 简介

这是一款为 Windows 平台上的求生之路2（Left 4 Dead 2）专用服务器量身打造的全能管理工具。它使用现代化、稳定可靠的 PowerShell 语言编写，旨在提供从服务器部署、实例管理到插件维护的一站式解决方案，彻底终结手动管理的繁琐、易错和低效。

通过本工具，您可以轻松部署和更新服务器，管理多个服务器实例的启停，设置定时任务，并以模块化的方式干净、无损地安装和移除 SourceMod 插件。

## 主要功能

  * **服务器部署与更新**
    脚本内置 SteamCMD 自动化功能。无论是首次安装还是日常更新 L4D2 服务器，只需一键即可完成，无需手动操作 SteamCMD。

  * **多实例管理**
    可以同时启动和管理多个服务器实例。您可以在配置中预设不同游戏模式（如战役、对抗）的启动参数，并通过菜单轻松启动或关闭它们。脚本会实时跟踪由它启动的进程，管理清晰。

  * **自动化定时任务**
    内置强大的定时任务管理器，可以为任何预设的服务器实例创建“定时启动”和“定时关机”的 Windows 计划任务。例如，实现服务器在每天晚上7点自动开启，凌晨2点自动关闭。

  * **一键安装/更新 SourceMod 与 MetaMod**
    只需将从官网下载的 `.zip` 安装包放入指定文件夹，脚本即可自动识别最新版本并完成解压、安装以及关键引导文件（`metamod.vdf`）的创建。

  * **模块化的插件管理**
    每个插件（及其所有相关文件，如`.smx`, `.cfg`, `.txt`等）都存放于一个独立的文件夹中，管理思路清晰，插件之间互不干扰。

  * **可逆的安装与移除**
    安装插件时，脚本会自动记录该插件包含的所有文件清单。当你选择移除插件时，脚本会根据这份清单，精确地将服务器中对应的文件一一安全地移回其原始位置，确保服务器文件纯净。

  * **强大的兼容性与交互界面**
    得益于 PowerShell 的原生 Unicode 支持，本工具可以完美处理任何语言和特殊字符的路径/文件名。所有操作均通过清晰的、支持键盘导航的可视化菜单完成，对新手服主非常友好。

## 使用方法

### 第一步：准备工作

1.  **系统要求：** 一台运行 Windows 10 或更高版本的电脑（或 Windows Server 2016+）。脚本需要以**管理员权限**运行。

2.  **创建目录结构：** 在你喜欢的位置（例如桌面）创建一个主管理文件夹，并将 `L4D2_Manager.ps1` 脚本文件放入其中。目录结构如下：

    ```
    L4D2_Manager/
    │
    └── L4D2_Manager.ps1        (本脚本)
    ```

      * 当你第一次运行脚本时，它会自动在同级目录下创建以下三个管理文件夹：
          * `Available_Plugins/`: 用于存放所有**待安装**的插件文件夹。
          * `Installed_Receipts/`: 用于存放已安装插件的回执文件（脚本自动管理，请勿手动修改）。
          * `SourceMod_Installers/`: 用于存放 SourceMod 和 MetaMod 的 `.zip` 安装包。

### 第二步：配置脚本

1.  用记事本、VS Code 或任何文本编辑器打开 `L4D2_Manager.ps1` 脚本文件。

2.  找到脚本最上方的 **`用户配置区`**，并根据你的实际情况修改以下三个设置：

    ```powershell
    # #################### 用户配置区 (请务必修改!) ####################
    #
    # 1. 设置您的L4D2服务器安装目录 (此目录将包含 srcds.exe 等文件)
    #    例如: "D:\L4D2Server"
    $ServerRoot = "D:\L4D2Server"
    #
    # 2. 设置 SteamCMD.exe 的完整路径。脚本将使用它来下载和更新服务器。
    #    如果文件不存在，脚本会尝试自动下载。
    #    例如: "C:\steamcmd\steamcmd.exe"
    $SteamCMDPath = "C:\steamcmd\steamcmd.exe"
    #
    # 3. (可选) 预定义服务器实例配置
    #    您可以在这里预设多个服务器的启动参数。
    $ServerInstances = @{
        "主服_战役" = @{
            Port = 27015
            HostName = "[CN] My L4D2 Campaign Server"
            MaxPlayers = 8
            StartMap = "c1m1_hotel"
            ExtraParams = "+sv_gametypes 'coop,realism,survival'"
        }
        "副服_对抗" = @{
            Port = 27016
            HostName = "[CN] My L4D2 Versus Server"
            MaxPlayers = 8
            StartMap = "c5m1_waterfront"
            ExtraParams = "+sv_gametypes 'versus,teamversus,scavenge'"
        }
    }
    #
    # #################################################################
    ```

      * `$ServerRoot`: **必须修改。** 这是你的 L4D2 专用服务器的根目录路径（即包含 `srcds.exe` 的那个文件夹的路径）。
      * `$SteamCMDPath`: **必须修改。** 这是 `steamcmd.exe` 文件的完整路径。如果路径下的文件不存在，脚本在执行部署功能时会尝试自动下载。
      * `$ServerInstances`: **强烈建议配置。** 在这里预设你想要运行的服务器实例。你可以自行调整启动参数，方便后续通过菜单一键启动或设置定时任务。

3.  保存并关闭文件。

### 第三步：运行脚本

#### A. 设置执行策略（首次使用，仅需操作一次）

出于安全考虑，Windows 默认禁止直接运行 PowerShell 脚本。你需要为当前用户开启权限。

1.  在 Windows 的开始菜单或搜索栏中输入 `PowerShell`。
2.  右键点击“**Windows PowerShell**”，选择“**以管理员身份运行**”。
3.  在打开的蓝色管理员窗口中，复制并粘贴以下命令，然后按回车：
    ```powershell
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
    ```
4.  系统会询问你是否要更改执行策略，输入 `A` 然后按回车表示“全是”。
5.  完成后，你可以关闭这个管理员窗口。此操作在你的电脑上只需进行一次。

#### B. 启动管理器

1.  右键点击 `L4D2_Manager.ps1` 脚本文件，选择“**使用 PowerShell 运行**” 或 “**以管理员身份运行**”。
      * 或者，进入 `L4D2_Manager` 文件夹，在地址栏输入 `powershell` 并回车，然后在打开的窗口中输入 `.\L4D2_Manager.ps1` 来启动脚本。

### 第四步：使用菜单

脚本启动后，你会看到一个清晰的主菜单。根据屏幕上的提示输入对应的数字即可执行相应操作：

  * **操作 [1] 部署/更新 L4D2 服务器文件：**

      * 执行此项后，脚本将调用 SteamCMD 自动下载或更新 L4D2 专用服务器到你在配置中指定的 `$ServerRoot` 目录。

  * **操作 [2] 管理服务器实例 (启动/关闭/定时)：**

      * **启动实例：** 从你在配置中预设的 `$ServerInstances` 列表或手动模式中选择一个来启动。
      * **关闭实例：** 关闭一个由本脚本启动的、正在运行的服务器实例。
      * **定时任务管理：** 为预设的实例创建、查看或删除 Windows 定时开关机任务。

  * **操作 [3] 安装 / 更新 SourceMod 和 MetaMod：**

      * 将从官网下载的 `sourcemod-xxx.zip` 和 `mmsource-xxx.zip` 文件直接放入 `SourceMod_Installers` 文件夹内，然后执行此选项。

  * **操作 [4] 安装插件：**

      * 将插件文件夹放入 `Available_Plugins` 目录中，然后执行此选项。
      * 为确保能正确安装，每个插件的目录结构必须如下所示：

        ```
        Available_Plugins/
        │
        └── [插件名]/
            │
            └── left4dead2/
                │
                ├── addons/
                ├── cfg/
                └── ...等其他文件
        ```

  * **操作 [5] 移除插件：**

      * 脚本会列出所有已安装的插件。选择你想移除的插件即可。脚本会自动将其所有相关文件安全地移回 `Available_Plugins` 文件夹中，实现完美卸载。
